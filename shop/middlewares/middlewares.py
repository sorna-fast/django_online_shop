# ๐ฏ Middleware ุฏุฑ Django ูุซู ูฺฏูุจุงูโูุง ูุณุชู ฺฉู ุฏู ุฏุฑ ุงุณุชุงุฏู!

# ูุฑ ุจุงุฑ ฺฉู ฺฉุงุฑุจุฑ ู ุฏุฑุฎูุงุณุช (request) ูโูุฑุณุชู ุจู ุณุงุชุ ุงู ุฏุฑุฎูุงุณุช ุจุงุฏ ุงุฒ ุฌูู ุงู ูฺฏูุจุงูโูุง ุฑุฏ ุจุดู.
# ูุฑ ูฺฏูุจุงู (ุง ูููู middleware) ูโุชููู ฺฉุงุฑ ุงูุฌุงู ุจุฏูุ ูุซูุงู:

#     ฺฉุงุฑุช ุดูุงุณุง ุฑู ฺฺฉ ฺฉูู (ุขุง ูุงฺฏู ฺฉุฑุฏู ุง ููุ)

#     ุฏุฑุฎูุงุณุช ุฑู ุซุจุช ฺฉูู (ุจุฑุง ูุงฺฏ ุง ุขูุงุฑ ฺฏุฑูุชู)

#     ุฏุฑุฎูุงุณุช ุฑู ุฑุฏ ฺฉูู ุง ุชุบุฑุด ุจุฏู

#     ูุจู ุงุฒ ุงูฺฉู ูพุงุณุฎ ุจู ฺฉุงุฑุจุฑ ุจุฑฺฏุฑุฏูุ ุขุฎุฑู ุจุฑุฑุณโูุง ุฑู ุงูุฌุงู ุจุฏู


# ----------------------------------------------------------------------------------------------------------------------

# ูุฑ ุฌ ูุฏููุฑ ุจุฎูุงู ุงูุฌุง ูููุณู

# ----------------------------------------------------------------------------------------------------------------------

# ุงฺฏู ุจุฎูุงู ุงุฒ ุฑฺฉูุฆุณุช ุฏุฑ ูุฏู ูุงู ุงุณุชูุงุฏู ฺฉูู

# ----------------------------------------------------------------------------------------------------------------------

# Middleware : ูุง ูุซู ููุชุฑูุง ูุณุชู ฺฉู ูุจู ุงุฒ ุฑุณุฏู ุฏุฑุฎูุงุณุช ุจู view ู ูุจู ุงุฒ ุจุฑฺฏุดุชู ูพุงุณุฎ ุจู ฺฉุงุฑุจุฑุ ุฑูุด ฺฉุงุฑ ูโฺฉูู.

# ----------------------------------------------------------------------------------------------------------------------

# ๐งต threading ฺูุ

# Django (ู ุฎู ุงุฒ ุจุฑูุงููโูุง ุฏฺฏู) ูโุชููู ฺูุฏ ุฏุฑุฎูุงุณุช ุฑู ููุฒูุงู ูุฏุฑุช ฺฉูู.
# ุจุฑุง ุงูฺฉู ุงู ุงุชูุงู ุจูุชูุ ุณุณุชู ุงุฒ Thread ุงุณุชูุงุฏู ูโฺฉููุ
# ุนู:
# ูุฑ ฺฉุงุฑุจุฑ ฺฉู ู ุตูุญู ุฑู ุจุงุฒ ูโฺฉููุ ูุซู ุงูู ฺฉู ู ุฎุท ูุฌุฒุง ุงุฌุฑุง (ู ูุฎ ุง Thread) ูุฎุตูุต ุฎูุฏุด ูโฺฏุฑู.
    
# ----------------------------------------------------------------------------------------------------------------------

# ๐ง ุญุงูุง threading.local() ฺูุ

# ุงููพูุฑุช ฺฉุฑุฏู ูุงฺูู threading ุจุฑุง ุงูฺฉู ุจุชููู ู ูุถุง ุงุฎุชุตุงุต ุจุฑุง ูุฑ ุฏุฑุฎูุงุณุช ุจุณุงุฒู.
# ุงู ู ูุถุง ูุฎุตูุต ุญุงูุธู ุจุฑุง ูุฑ Thread ูุณุช.
# ุนู ฺุ ๐ค
# ูุฑุถ ฺฉู ฺฉุงุฑุจุฑ A ุฏุงุฑู ูุงุฑุฏ ุณุงุช ูุดู ู ููุฒูุงู ฺฉุงุฑุจุฑ B ูู ุฏุงุฑู ูุงุฑุฏ ูุดู.
# ูุฑฺฉุฏูู ุฏุฑุฎูุงุณุช ุฎูุฏุด ุฑู ุฏุงุฑู. ูุง ููโุฎูุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ A ุงุดุชุจุงู ุจู ฺฉุงุฑุจุฑ B ูุดูู ุฏุงุฏู ุจุดู!
# ุงูุฌุง threading.local() ุจู ูุง ฺฉูฺฉ ูโฺฉูู ฺฉู ุจฺฏู:
# "ุงู ูุชุบุฑ ููุท ูุฎุตูุต ููู ฺฉุงุฑุจุฑ ู ููู ุฏุฑุฎูุงุณุช ุจุงุดู."
    
# ----------------------------------------------------------------------------------------------------------------------

# ููุช Django ุงู middleware ุฑู ููุฏ ูโฺฉูู:
#     get_response ู ุชุงุจุน ูุณุช ฺฉู ูุณุฆูู ุฑุณุฏฺฏ ุจู ุฏุฑุฎูุงุณุช ุจุนุฏ ุฏุฑ ุฒูุฌุฑูโ middleware ูุงุณุช.
#     self.thread_local ู ูุชุบุฑ ูุฎุตูุต ูฺฏูุฏุงุฑ request ูุนูู. ูู ุจู ุตูุฑุช ุงุฎุชุตุงุต ุจุฑุง ูุฑ ุฏุฑุฎูุงุณุช ุฌุฏุง.

# ----------------------------------------------------------------------------------------------------------------------

# self.thread_local.current_request = request
# ุนู: "ุจุฐุงุฑ ุงู ุฏุฑุฎูุงุณุช ุฑู ุจู ุทูุฑ ุงุฎุชุตุงุต ุจุฑุง ุงู thread (ฺฉุงุฑุจุฑ) ุฐุฎุฑู ฺฉูู."

# ----------------------------------------------------------------------------------------------------------------------

# ุงู ฺฉุฏ ู middleware ูโุณุงุฒู ฺฉู ุฏุฑุฎูุงุณุช (request) ฺฉุงุฑุจุฑ ุฑู ุจู ุตูุฑุช ุงุฎุชุตุงุต ู ุงูู ุจุฑุง ุงูู ฺฉุงุฑุจุฑ (thread) ูฺฏู ูโุฏุงุฑูุ ุชุง ุจุนุฏุงู ุงุฒ ูุฑุฌุง ุฏฺฏูโุง ุจุดู ุจูุด ุฏุณุชุฑุณ ุฏุงุดุชุ ุจุฏูู ุงูฺฉู ูุงุท ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ ุฏฺฏู ุจุดู.

# ----------------------------------------------------------------------------------------------------------------------


import threading

class RequestMiddleware:
    def __init__(self, get_response, thread_local=threading.local()):
        self.get_response = get_response
        self.thread_local = thread_local
        
    def __call__(self, request):
        self.thread_local.current_request = request
        response = self.get_response(request)
        return response